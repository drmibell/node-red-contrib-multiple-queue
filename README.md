# node-red-contrib-multiple-queue
A Node-RED node providing multiple, independently controlled message queues

## Install

Use the Node-RED `Manage Palette` command or run the following command in the Node-RED user directory (typically `~/.node-red`):

    npm install node-red-contrib-multiple-queue
    
    
## Design
The `m-queue` node provides multiple, independently controlled message queues. Each queue behaves similarly to the `queueing` state of the [node-red-contrib-queue-gate](https://flows.nodered.org/node/node-red-contrib-queue-gate) node. The requirement to control each queue individually, however, adds some complexity to the design, and this is reflected in the control mechanism. Queues are created as needed and destroyed when empty, except for the `Default Queue` (see below). Each queue is identified by a `Name` string, which is used to steer messages to it, where they are stored or used to control the queue. This name is matched against the `Queue Selector` string provided by default in the `msg.topic` property, but the user can select any other message property for this purpose, thus retaining flexibility. Similarly, all the other message properties used to control the queues are defined by default but are available to be customized in the node edit dialog.

## Usage

An incoming message is added to the queue identified by the `Queue Selector`. If no such queue exists, one is created. If the `Queue Selector` is `undefined` or an empty string, the message is added to the queue identified as `default`, which is always available. Messages with the user-defined property `Control Flag` set to `true` (or a JavaScript equivalent) are not queued but are used to control the queues. These control messages can have payloads (case-insensitive strings) that the user has defined to represent commands for `trigger`, `pause`, `resume`,`flush`, `peek`, `drop`, `reset`, `status`, and `maximum`. If a control message is received with a payload that is a number or boolean, the payload is converted to a string and then tested against the command definitions. If a control message is received but not recognized, there is no output or change of state, and the node issues a warning. A message to be queued or a control message can sent to all queues by setting the `Queue Selector` to the value defined in `All Queues`.

Each queue responds independently to control messages addressed to it by performing the following actions:
<p align="center"> <img  src="https://github.com/drmibell/node-red-contrib-multiple-queue/blob/main/images/definitions.png?raw=true" width="85%"></p>

Further information on the `peek` and `drop` commands can be found in the documentation for the [node-red-contrib-queue-gate](https://flows.nodered.org/node/node-red-contrib-queue-gate) node. If a queue has been paused by `pause` command, it will no longer queue incoming messages or accept most commands. Only commands that do not affect the contents of a queue will be executed while it is paused. These are indicated by an asterisk in the table above.  

A limited indication of node activity is provided by the status text, which displays the number of queues in operation and the total number of messages queued. When a `status` command is received, the status text is refreshed so that it can be caught by a `status` node. In addition, if the `Send status to second output` checkbox is selected in the edit dialog, the node is deployed with a second output that sends a complete description of the selected queue(s) in the form of an object of the form shown:
<p align="center"> <img  src="https://github.com/drmibell/node-red-contrib-multiple-queue/blob/main/images/status.png?raw=true" width="85%"></p>

The user can limit the size of each queue to prevent memory problems. The `default` queue and all new queues will be created with the limit specified in the edit dialog. This can be changed by addressing a `maximum` command to one or all queues and providing the maximum value in the `Queue Limit` property. 

By default, messages arriving when a queue is full are discarded, so that the queue contains the oldest messages. The user can, however, set the `Keep newest messages` checkbox in order to have the `default` queue and all new queues created with the opposite behavior: new messages are added to the queue (at the tail), while discarding the oldest message (from the head), with the result that the queue contains the most recent messages. This behavior can be controlled on an individual queue basis by addressing a control message to that queue with the `Newest Flag` property set to `true` or `false`.

Changes to the maximum queue size or the `Keep newest messages` property do not affect messages already in the queue.

The state of the node (all queues and their contents) is maintained in the node context. If a persistent (non-volatile) form of context storage is available, the user has the option of restoring the state from that storage after a restart of Node-RED. This is done by activating the `Restore from state saved in` option (checkbox) in the edit dialog and choosing a non-volatile storage module from the adjacent dropdown list, which shows all the storage modules enabled in the Node-RED `settings.js` file.

## Examples
### Basic Operation
This flow demonstrates the basic operation of the `m-queue` node and the commands that can be used to change or display its state or manage the queue.
```
[{"id":"2e81b27e.38c676","type":"inject","z":"75a2f227.f318d4","name":"input","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"","payloadType":"date","x":130,"y":260,"wires":[["8f51fc27.7461a"]]},{"id":"7331f684.0d42e8","type":"inject","z":"75a2f227.f318d4","name":"input","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"queue1","payload":"","payloadType":"date","x":490,"y":100,"wires":[["9a8b71f3.b3b6a8"]]},{"id":"d4a8baa4.2ed418","type":"inject","z":"75a2f227.f318d4","name":"trigger","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"trigger","payloadType":"str","x":270,"y":80,"wires":[["8f51fc27.7461a"]]},{"id":"e2d5eba0.e82968","type":"inject","z":"75a2f227.f318d4","name":"peek","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"peek","payloadType":"str","x":270,"y":240,"wires":[["8f51fc27.7461a"]]},{"id":"62b8ebe6.e34254","type":"inject","z":"75a2f227.f318d4","name":"pause","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"pause","payloadType":"str","x":270,"y":120,"wires":[["8f51fc27.7461a"]]},{"id":"2968d6c2.1c426a","type":"inject","z":"75a2f227.f318d4","name":"resume","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"resume","payloadType":"str","x":270,"y":160,"wires":[["8f51fc27.7461a"]]},{"id":"524b3a66.c598fc","type":"inject","z":"75a2f227.f318d4","name":"drop","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"drop","payloadType":"str","x":270,"y":280,"wires":[["8f51fc27.7461a"]]},{"id":"d475141f.f79e6","type":"inject","z":"75a2f227.f318d4","name":"flush","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"flush","payloadType":"str","x":270,"y":200,"wires":[["8f51fc27.7461a"]]},{"id":"5c857d77.ef0034","type":"inject","z":"75a2f227.f318d4","name":"flush","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"queue1","payload":"flush","payloadType":"str","x":650,"y":120,"wires":[["9a8b71f3.b3b6a8"]]},{"id":"7bdcc2a.3d5bf3c","type":"inject","z":"75a2f227.f318d4","name":"reset","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"reset","payloadType":"str","x":270,"y":320,"wires":[["8f51fc27.7461a"]]},{"id":"a34c033a.3c84c","type":"inject","z":"75a2f227.f318d4","name":"reset","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"queue1","payload":"reset","payloadType":"str","x":650,"y":200,"wires":[["9a8b71f3.b3b6a8"]]},{"id":"9413257a.f34068","type":"inject","z":"75a2f227.f318d4","name":"maximum","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"},{"p":"maximum","v":"1","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"maximum","payloadType":"str","x":260,"y":360,"wires":[["8f51fc27.7461a"]]},{"id":"52ea570d.d57e08","type":"inject","z":"75a2f227.f318d4","name":"status","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"status","payloadType":"str","x":270,"y":440,"wires":[["8f51fc27.7461a"]]},{"id":"7ee4d0ac.0358a","type":"inject","z":"75a2f227.f318d4","name":"trigger","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"queue1","payload":"trigger","payloadType":"str","x":650,"y":80,"wires":[["9a8b71f3.b3b6a8"]]},{"id":"26c05686.a92e92","type":"inject","z":"75a2f227.f318d4","name":"input","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"all","payload":"","payloadType":"date","x":590,"y":340,"wires":[["7a7221f7.febf3"]]},{"id":"1d0498ae.977b07","type":"comment","z":"75a2f227.f318d4","name":"default queue","info":"","x":250,"y":40,"wires":[]},{"id":"8f51fc27.7461a","type":"link out","z":"75a2f227.f318d4","name":"","links":["7f658eda.a31058"],"x":455,"y":260,"wires":[]},{"id":"9a8b71f3.b3b6a8","type":"link out","z":"75a2f227.f318d4","name":"","links":["7f658eda.a31058","10a5a17f.d199af"],"x":795,"y":100,"wires":[]},{"id":"6e0fa707.f6df7","type":"comment","z":"75a2f227.f318d4","name":"queue #1","info":"","x":640,"y":40,"wires":[]},{"id":"7a7221f7.febf3","type":"link out","z":"75a2f227.f318d4","name":"","links":["7f658eda.a31058"],"x":795,"y":340,"wires":[]},{"id":"7f658eda.a31058","type":"link in","z":"75a2f227.f318d4","name":"","links":["41a22656.ad437","7a7221f7.febf3","8f51fc27.7461a","9a8b71f3.b3b6a8"],"x":295,"y":500,"wires":[["d9e9db7c.1f12"]]},{"id":"34529be4.051ac4","type":"comment","z":"75a2f227.f318d4","name":"all queues","info":"","x":640,"y":260,"wires":[]},{"id":"d90cbf00.23cf","type":"inject","z":"75a2f227.f318d4","name":"newest","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"},{"p":"newest","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"default","payload":"newest","payloadType":"str","x":270,"y":400,"wires":[["8f51fc27.7461a"]]},{"id":"29489dd3.db6d2a","type":"inject","z":"75a2f227.f318d4","name":"peek","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"queue1","payload":"peek","payloadType":"str","x":650,"y":160,"wires":[["9a8b71f3.b3b6a8"]]},{"id":"a057816c.0028a8","type":"inject","z":"75a2f227.f318d4","name":"trigger","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"all","payload":"trigger","payloadType":"str","x":650,"y":300,"wires":[["7a7221f7.febf3"]]},{"id":"98b3dc41.f34378","type":"inject","z":"75a2f227.f318d4","name":"reset","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"all","payload":"reset","payloadType":"str","x":650,"y":380,"wires":[["7a7221f7.febf3"]]},{"id":"8005b7c4.45eb38","type":"debug","z":"75a2f227.f318d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":500,"wires":[]},{"id":"1890649a.137773","type":"status","z":"75a2f227.f318d4","name":"","scope":null,"x":400,"y":560,"wires":[["25632026.e297c8"]]},{"id":"25632026.e297c8","type":"debug","z":"75a2f227.f318d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"status.text","targetType":"msg","statusVal":"","statusType":"auto","x":560,"y":560,"wires":[]},{"id":"cd879e3a.5c237","type":"inject","z":"75a2f227.f318d4","name":"status","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"all","payload":"status","payloadType":"str","x":650,"y":420,"wires":[["7a7221f7.febf3"]]},{"id":"d9e9db7c.1f12","type":"m-queue","z":"75a2f227.f318d4","name":"","queueSelect":"topic","controlFlag":"control","defaultQueue":"default","allQueues":"all","triggerCmd":"trigger","statusCmd":"status","pauseCmd":"pause","resumeCmd":"resume","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","paused":false,"keepNewestDefault":false,"maxSizeDefault":100,"setMaximumFlag":"maximum","keepNewestFlag":"newest","persist":false,"storeName":"memoryOnly","statusOutput":false,"outputs":1,"x":400,"y":500,"wires":[["8005b7c4.45eb38"]]}]
```
<img src="https://github.com/drmibell/node-red-contrib-multiple-queue/blob/main/screenshots/m-queue-demo.png?raw=true"/>

### Node Status
This flow shows the default response to the `status` command and the optional use of a second output to obtain the complete status object for one or all queues.
```
[{"id":"fff3933.09139f","type":"inject","z":"a25c5984.bb3248","name":"status","props":[{"p":"payload"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"status","payloadType":"str","x":210,"y":160,"wires":[["fece2ca1.c5a24"]]},{"id":"2098ab05.a81144","type":"debug","z":"a25c5984.bb3248","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":120,"wires":[]},{"id":"ae212584.32f4a8","type":"status","z":"a25c5984.bb3248","name":"","scope":["fece2ca1.c5a24"],"x":360,"y":180,"wires":[["e07b4047.96a12"]]},{"id":"e07b4047.96a12","type":"debug","z":"a25c5984.bb3248","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"status.text","targetType":"msg","statusVal":"","statusType":"auto","x":520,"y":180,"wires":[]},{"id":"fece2ca1.c5a24","type":"m-queue","z":"a25c5984.bb3248","name":"queue #1","queueSelect":"topic","controlFlag":"control","defaultQueue":"default","allQueues":"all","triggerCmd":"trigger","statusCmd":"status","pauseCmd":"pause","resumeCmd":"resume","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","paused":false,"keepNewestDefault":false,"maxSizeDefault":100,"setMaximumFlag":"maximum","keepNewestFlag":"newest","persist":false,"storeName":"memoryOnly","statusOutput":false,"outputs":1,"x":360,"y":120,"wires":[["2098ab05.a81144"]]},{"id":"88fc842e.b843a","type":"debug","z":"a25c5984.bb3248","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":260,"wires":[]},{"id":"ec7e050a.da048","type":"m-queue","z":"a25c5984.bb3248","name":"queue #2","queueSelect":"topic","controlFlag":"control","defaultQueue":"default","allQueues":"all","triggerCmd":"trigger","statusCmd":"status","pauseCmd":"pause","resumeCmd":"resume","flushCmd":"flush","resetCmd":"reset","peekCmd":"peek","dropCmd":"drop","paused":false,"keepNewestDefault":false,"maxSizeDefault":100,"setMaximumFlag":"maximum","keepNewestFlag":"newest","persist":false,"storeName":"memoryOnly","statusOutput":true,"outputs":2,"x":360,"y":280,"wires":[["88fc842e.b843a"],["1c011b1d.17da95"]]},{"id":"1c011b1d.17da95","type":"debug","z":"a25c5984.bb3248","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":510,"y":300,"wires":[]},{"id":"8e739fe6.11563","type":"inject","z":"a25c5984.bb3248","name":"input","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":120,"wires":[["fece2ca1.c5a24"]]},{"id":"b3cb0e71.5314a8","type":"inject","z":"a25c5984.bb3248","name":"status","props":[{"p":"payload"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"status","payloadType":"str","x":210,"y":320,"wires":[["ec7e050a.da048"]]},{"id":"67f91541.df8e14","type":"inject","z":"a25c5984.bb3248","name":"input","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":280,"wires":[["ec7e050a.da048"]]},{"id":"9b2f745c.baab3","type":"inject","z":"a25c5984.bb3248","name":"trigger","props":[{"p":"payload"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"trigger","payloadType":"str","x":210,"y":80,"wires":[["fece2ca1.c5a24"]]},{"id":"3e4571de.1304ee","type":"inject","z":"a25c5984.bb3248","name":"trigger","props":[{"p":"payload"},{"p":"control","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"trigger","payloadType":"str","x":210,"y":240,"wires":[["ec7e050a.da048"]]}]
```
<img src="https://github.com/drmibell/node-red-contrib-multiple-queue/blob/main/screenshots/m-queue-status.png?raw=true"/>

## Author
[Mike Bell](https://www.linkedin.com/in/drmichaelbell/) (drmike)
